---
// è¨˜äº‹åŸ·ç­†æ”¯æ´ãƒ„ãƒ¼ãƒ«
interface Props {
  postContent?: string;
}

const { postContent = '' } = Astro.props;
---

<div class="writing-assistant" id="writing-assistant">
  <h3>åŸ·ç­†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h3>
  
  <div class="assistant-sections">
    <!-- SEOã‚¹ã‚³ã‚¢ -->
    <div class="assistant-section">
      <h4>ğŸ“Š SEOã‚¹ã‚³ã‚¢</h4>
      <div class="seo-metrics">
        <div class="metric">
          <span class="metric-label">æ–‡å­—æ•°:</span>
          <span class="metric-value" id="char-count">0</span>
          <span class="metric-target">/ 1,500æ–‡å­—ä»¥ä¸Šæ¨å¥¨</span>
        </div>
        <div class="metric">
          <span class="metric-label">è¦‹å‡ºã—æ•°:</span>
          <span class="metric-value" id="heading-count">0</span>
          <span class="metric-target">/ 3ã¤ä»¥ä¸Šæ¨å¥¨</span>
        </div>
        <div class="metric">
          <span class="metric-label">ç”»åƒæ•°:</span>
          <span class="metric-value" id="image-count">0</span>
          <span class="metric-target">/ 2ã¤ä»¥ä¸Šæ¨å¥¨</span>
        </div>
        <div class="metric">
          <span class="metric-label">å†…éƒ¨ãƒªãƒ³ã‚¯:</span>
          <span class="metric-value" id="internal-link-count">0</span>
          <span class="metric-target">/ 3ã¤ä»¥ä¸Šæ¨å¥¨</span>
        </div>
      </div>
      <div class="seo-score">
        <div class="score-bar">
          <div class="score-fill" id="seo-score-fill"></div>
        </div>
        <span class="score-text" id="seo-score-text">0/100</span>
      </div>
    </div>

    <!-- æ¨å¥¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ -->
    <div class="assistant-section">
      <h4>ğŸ”‘ æ¨å¥¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h4>
      <div class="keyword-suggestions" id="keyword-suggestions">
        <div class="keyword-chip">Python ãƒ‡ãƒ¼ã‚¿åˆ†æ</div>
        <div class="keyword-chip">pandas ä½¿ã„æ–¹</div>
        <div class="keyword-chip">æ©Ÿæ¢°å­¦ç¿’ å…¥é–€</div>
      </div>
    </div>

    <!-- èª­ã¿ã‚„ã™ã•ã‚¹ã‚³ã‚¢ -->
    <div class="assistant-section">
      <h4>ğŸ“– èª­ã¿ã‚„ã™ã•</h4>
      <div class="readability-metrics">
        <div class="metric">
          <span class="metric-label">å¹³å‡æ–‡é•·:</span>
          <span class="metric-value" id="avg-sentence-length">0</span>
          <span class="metric-status">æ–‡å­—</span>
        </div>
        <div class="metric">
          <span class="metric-label">é›£èª­æ¼¢å­—:</span>
          <span class="metric-value" id="difficult-kanji">0</span>
          <span class="metric-status">å€‹</span>
        </div>
      </div>
    </div>

    <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
    <div class="assistant-section">
      <h4>âœ… æŠ•ç¨¿å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h4>
      <div class="checklist">
        <label class="checklist-item">
          <input type="checkbox" />
          <span>ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€</span>
        </label>
        <label class="checklist-item">
          <input type="checkbox" />
          <span>ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š</span>
        </label>
        <label class="checklist-item">
          <input type="checkbox" />
          <span>ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒã‚’è¨­å®š</span>
        </label>
        <label class="checklist-item">
          <input type="checkbox" />
          <span>ã‚«ãƒ†ã‚´ãƒªã¨ã‚¿ã‚°ã‚’é©åˆ‡ã«è¨­å®š</span>
        </label>
        <label class="checklist-item">
          <input type="checkbox" />
          <span>å†…éƒ¨ãƒªãƒ³ã‚¯ã‚’3ã¤ä»¥ä¸Šè¿½åŠ </span>
        </label>
        <label class="checklist-item">
          <input type="checkbox" />
          <span>èª¤å­—è„±å­—ã‚’ãƒã‚§ãƒƒã‚¯</span>
        </label>
      </div>
    </div>
  </div>

  <button class="assistant-toggle" id="assistant-toggle">
    <span class="toggle-icon">ğŸ“</span>
  </button>
</div>

<style>
  .writing-assistant {
    @apply fixed right-4 top-20 z-40;
    @apply bg-[var(--card-color)] rounded-lg shadow-xl;
    @apply w-80 max-h-[80vh] overflow-y-auto;
    @apply transition-transform duration-300;
    @apply transform translate-x-0;
  }

  .writing-assistant.collapsed {
    @apply translate-x-[calc(100%+1rem)];
  }

  .writing-assistant h3 {
    @apply text-lg font-bold p-4 border-b border-[var(--border-color)];
    @apply sticky top-0 bg-[var(--card-color)] z-10;
  }

  .assistant-sections {
    @apply p-4 space-y-4;
  }

  .assistant-section {
    @apply border border-[var(--border-color)] rounded-lg p-3;
  }

  .assistant-section h4 {
    @apply text-sm font-semibold mb-2 text-[var(--text-color)];
  }

  /* ãƒ¡ãƒˆãƒªã‚¯ã‚¹ */
  .seo-metrics, .readability-metrics {
    @apply space-y-2;
  }

  .metric {
    @apply flex items-center text-sm;
  }

  .metric-label {
    @apply text-[var(--text-color-lighten)] mr-2;
  }

  .metric-value {
    @apply font-bold text-[var(--text-color)] mr-1;
  }

  .metric-target, .metric-status {
    @apply text-xs text-[var(--text-color-lighten)];
  }

  /* SEOã‚¹ã‚³ã‚¢ */
  .seo-score {
    @apply mt-3 flex items-center gap-2;
  }

  .score-bar {
    @apply flex-1 h-2 bg-[var(--border-color)] rounded-full overflow-hidden;
  }

  .score-fill {
    @apply h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500;
    @apply transition-all duration-500;
    width: 0%;
  }

  .score-text {
    @apply text-sm font-bold;
  }

  /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ */
  .keyword-suggestions {
    @apply flex flex-wrap gap-2;
  }

  .keyword-chip {
    @apply px-2 py-1 text-xs rounded-full;
    @apply bg-[var(--primary-color-lighten)] text-[var(--primary-color)];
    @apply cursor-pointer transition-all duration-200;
  }

  .keyword-chip:hover {
    @apply bg-[var(--primary-color)] text-white;
  }

  /* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ */
  .checklist {
    @apply space-y-2;
  }

  .checklist-item {
    @apply flex items-center gap-2 text-sm cursor-pointer;
    @apply text-[var(--text-color-lighten)];
  }

  .checklist-item input:checked + span {
    @apply line-through text-[var(--text-color)];
  }

  /* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
  .assistant-toggle {
    @apply absolute -left-12 top-4;
    @apply w-10 h-10 rounded-lg;
    @apply bg-[var(--primary-color)] text-white;
    @apply flex items-center justify-center;
    @apply shadow-lg hover:shadow-xl;
    @apply transition-all duration-300;
  }

  .assistant-toggle:hover {
    @apply transform scale-110;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«éè¡¨ç¤º */
  @media (max-width: 1024px) {
    .writing-assistant {
      @apply hidden;
    }
  }
</style>

<script>
  function initWritingAssistant() {
    const assistant = document.getElementById('writing-assistant');
    const toggle = document.getElementById('assistant-toggle');
    const article = document.querySelector('.post-article');
    
    if (!assistant || !toggle || !article) return;

    // ãƒˆã‚°ãƒ«æ©Ÿèƒ½
    let isCollapsed = localStorage.getItem('writing-assistant-collapsed') === 'true';
    if (isCollapsed) assistant.classList.add('collapsed');

    toggle.addEventListener('click', () => {
      isCollapsed = !isCollapsed;
      assistant.classList.toggle('collapsed');
      localStorage.setItem('writing-assistant-collapsed', isCollapsed.toString());
    });

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ†æ
    function analyzeContent() {
      const content = article.textContent || '';
      const html = article.innerHTML || '';

      // æ–‡å­—æ•°
      const charCount = content.length;
      document.getElementById('char-count')!.textContent = charCount.toString();

      // è¦‹å‡ºã—æ•°
      const headings = article.querySelectorAll('h2, h3').length;
      document.getElementById('heading-count')!.textContent = headings.toString();

      // ç”»åƒæ•°
      const images = article.querySelectorAll('img').length;
      document.getElementById('image-count')!.textContent = images.toString();

      // å†…éƒ¨ãƒªãƒ³ã‚¯æ•°
      const internalLinks = article.querySelectorAll('a[href^="/"]').length;
      document.getElementById('internal-link-count')!.textContent = internalLinks.toString();

      // å¹³å‡æ–‡é•·
      const sentences = content.split(/[ã€‚ï¼ï¼Ÿ]/).filter(s => s.trim());
      const avgLength = sentences.length > 0 
        ? Math.round(sentences.reduce((sum, s) => sum + s.length, 0) / sentences.length)
        : 0;
      document.getElementById('avg-sentence-length')!.textContent = avgLength.toString();

      // SEOã‚¹ã‚³ã‚¢è¨ˆç®—
      let score = 0;
      if (charCount >= 1500) score += 25;
      else score += Math.floor((charCount / 1500) * 25);
      
      if (headings >= 3) score += 25;
      else score += Math.floor((headings / 3) * 25);
      
      if (images >= 2) score += 25;
      else score += Math.floor((images / 2) * 25);
      
      if (internalLinks >= 3) score += 25;
      else score += Math.floor((internalLinks / 3) * 25);

      // ã‚¹ã‚³ã‚¢è¡¨ç¤º
      const scoreFill = document.getElementById('seo-score-fill') as HTMLElement;
      const scoreText = document.getElementById('seo-score-text')!;
      
      scoreFill.style.width = `${score}%`;
      scoreText.textContent = `${score}/100`;
      
      // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
      if (score >= 80) scoreText.style.color = '#10b981';
      else if (score >= 60) scoreText.style.color = '#f59e0b';
      else scoreText.style.color = '#ef4444';
    }

    // åˆå›åˆ†æ
    analyzeContent();

    // å®šæœŸçš„ã«å†åˆ†æï¼ˆç·¨é›†ä¸­ã®å ´åˆï¼‰
    if (window.location.pathname.includes('edit') || window.location.pathname.includes('new')) {
      setInterval(analyzeContent, 5000);
    }
  }

  // åˆæœŸåŒ–
  document.addEventListener('astro:page-load', initWritingAssistant);
  document.addEventListener('DOMContentLoaded', initWritingAssistant);
</script>