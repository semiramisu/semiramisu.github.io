---
// èª­äº†ç‡ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
---

<script>
  // èª­äº†ç‡ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æ©Ÿèƒ½
  function initReadingDepthTracker() {
    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã™ã‚‹ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼ˆ%ï¼‰
    const milestones = [10, 25, 50, 75, 90, 100];
    const reachedMilestones = new Set();
    
    // è¨˜äº‹æœ¬æ–‡ã®è¦ç´ ã‚’å–å¾—
    const articleElement = document.querySelector('.post-article');
    if (!articleElement) return;
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚é–“ã®è¨ˆæ¸¬
    let scrollStartTime = Date.now();
    let totalReadingTime = 0;
    let isReading = true;
    
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼
    let scrollTimer: NodeJS.Timeout;
    let idleTimer: NodeJS.Timeout;
    
    // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦ã‚’è¨ˆç®—
    function calculateScrollDepth() {
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollTop = window.scrollY;
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªé«˜ã•
      const scrollableHeight = documentHeight - windowHeight;
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å‰²åˆï¼ˆ0-100ï¼‰
      const scrollPercentage = scrollableHeight > 0 
        ? Math.min(100, Math.round((scrollTop / scrollableHeight) * 100))
        : 0;
        
      return scrollPercentage;
    }
    
    // Google Analyticsã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
    function sendAnalyticsEvent(eventName: string, parameters: any) {
      // @ts-ignore
      if (typeof gtag !== 'undefined') {
        // @ts-ignore
        gtag('event', eventName, parameters);
      }
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
      if (import.meta.env.DEV) {
        console.log(`ğŸ“Š Analytics Event: ${eventName}`, parameters);
      }
    }
    
    // èª­äº†æ·±åº¦ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
    function trackReadingDepth() {
      const currentDepth = calculateScrollDepth();
      
      // åˆ°é”ã—ãŸãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
      milestones.forEach(milestone => {
        if (currentDepth >= milestone && !reachedMilestones.has(milestone)) {
          reachedMilestones.add(milestone);
          
          // è¨˜äº‹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const pageTitle = document.querySelector('h1')?.textContent || 'Unknown';
          const currentUrl = window.location.pathname;
          
          // ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
          sendAnalyticsEvent('reading_depth', {
            'percent_scrolled': milestone,
            'page_title': pageTitle,
            'page_location': currentUrl,
            'reading_time_seconds': Math.round(totalReadingTime / 1000)
          });
          
          // 100%åˆ°é”æ™‚ã¯èª­äº†ã‚¤ãƒ™ãƒ³ãƒˆã‚‚é€ä¿¡
          if (milestone === 100) {
            sendAnalyticsEvent('article_read_complete', {
              'page_title': pageTitle,
              'page_location': currentUrl,
              'total_reading_time_seconds': Math.round(totalReadingTime / 1000)
            });
          }
        }
      });
    }
    
    // ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã®æ¤œå‡º
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      
      if (!isReading) {
        isReading = true;
        scrollStartTime = Date.now();
      }
      
      idleTimer = setTimeout(() => {
        // 30ç§’é–“æ“ä½œãŒãªã‘ã‚Œã°èª­æ›¸ã‚’ä¸­æ–­ã¨ã¿ãªã™
        if (isReading) {
          totalReadingTime += Date.now() - scrollStartTime;
          isReading = false;
        }
      }, 30000);
    }
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    function handleScroll() {
      clearTimeout(scrollTimer);
      resetIdleTimer();
      
      // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆ100msï¼‰
      scrollTimer = setTimeout(() => {
        trackReadingDepth();
      }, 100);
    }
    
    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®å‡¦ç†
    function handlePageExit() {
      if (isReading) {
        totalReadingTime += Date.now() - scrollStartTime;
      }
      
      const finalDepth = calculateScrollDepth();
      const pageTitle = document.querySelector('h1')?.textContent || 'Unknown';
      const currentUrl = window.location.pathname;
      
      // é›¢è„±æ™‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
      sendAnalyticsEvent('reading_session_end', {
        'final_scroll_depth': finalDepth,
        'page_title': pageTitle,
        'page_location': currentUrl,
        'total_reading_time_seconds': Math.round(totalReadingTime / 1000),
        'milestones_reached': Array.from(reachedMilestones).join(',')
      });
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('beforeunload', handlePageExit);
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        handlePageExit();
      } else {
        scrollStartTime = Date.now();
        isReading = true;
      }
    });
    
    // åˆæœŸåŒ–æ™‚ã«ã‚‚ãƒã‚§ãƒƒã‚¯
    trackReadingDepth();
    resetIdleTimer();
    
    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
    return () => {
      window.removeEventListener('scroll', handleScroll);
      window.removeEventListener('beforeunload', handlePageExit);
      clearTimeout(scrollTimer);
      clearTimeout(idleTimer);
    };
  }
  
  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸåŒ–
  document.addEventListener('astro:page-load', () => {
    // è¨˜äº‹ãƒšãƒ¼ã‚¸ã§ã®ã¿å®Ÿè¡Œ
    if (document.querySelector('.post-article')) {
      initReadingDepthTracker();
    }
  });
  
  // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚
  if (document.querySelector('.post-article')) {
    initReadingDepthTracker();
  }
</script>