---
// Web Pushé€šçŸ¥ã®è³¼èª­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
---

<div class="notification-subscribe">
  <div class="subscribe-card">
    <div class="subscribe-header">
      <h3>ğŸ”” æ–°ç€è¨˜äº‹ã®é€šçŸ¥ã‚’å—ã‘å–ã‚‹</h3>
      <p>ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã§æœ€æ–°è¨˜äº‹ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™</p>
    </div>
    
    <div class="subscribe-content">
      <button id="subscribe-button" class="subscribe-button">
        <span class="button-icon">ğŸ””</span>
        <span class="button-text">é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
      </button>
      
      <div class="subscribe-status" id="subscribe-status" style="display: none;">
        <span class="status-icon">âœ…</span>
        <span class="status-text">é€šçŸ¥ã‚’å—ã‘å–ã‚‹è¨­å®šã«ãªã£ã¦ã„ã¾ã™</span>
      </div>
      
      <div class="subscribe-benefits">
        <h4>é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ï¼š</h4>
        <ul>
          <li>æ–°ç€è¨˜äº‹ã‚’å³åº§ã«ãŠçŸ¥ã‚‰ã›</li>
          <li>äººæ°—è¨˜äº‹ã®æ›´æ–°æƒ…å ±</li>
          <li>æœˆ1å›ã®è¨˜äº‹ã¾ã¨ã‚</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<style>
  .notification-subscribe {
    @apply my-8;
  }

  .subscribe-card {
    @apply bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20;
    @apply rounded-xl p-6 border-2 border-purple-200 dark:border-purple-800;
  }

  .subscribe-header h3 {
    @apply text-xl font-bold mb-2 text-gray-800 dark:text-gray-200;
  }

  .subscribe-header p {
    @apply text-gray-600 dark:text-gray-400;
  }

  .subscribe-content {
    @apply mt-4 space-y-4;
  }

  .subscribe-button {
    @apply w-full py-3 px-6 rounded-lg;
    @apply bg-gradient-to-r from-purple-600 to-pink-600;
    @apply text-white font-semibold;
    @apply flex items-center justify-center gap-2;
    @apply transition-all duration-300;
    @apply hover:shadow-lg hover:scale-[1.02];
  }

  .subscribe-button:disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  .button-icon {
    @apply text-xl;
  }

  .subscribe-status {
    @apply flex items-center gap-2;
    @apply text-green-600 dark:text-green-400;
    @apply bg-green-50 dark:bg-green-900/20;
    @apply py-2 px-4 rounded-lg;
  }

  .subscribe-benefits {
    @apply mt-4 pt-4 border-t border-purple-200 dark:border-purple-800;
  }

  .subscribe-benefits h4 {
    @apply text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300;
  }

  .subscribe-benefits ul {
    @apply space-y-1;
  }

  .subscribe-benefits li {
    @apply text-sm text-gray-600 dark:text-gray-400;
    @apply flex items-start gap-2;
  }

  .subscribe-benefits li::before {
    content: "âœ¨";
    @apply flex-shrink-0 mt-0.5;
  }
</style>

<script>
  // Service Workerã®ç™»éŒ²ã¨é€šçŸ¥è³¼èª­
  async function initNotifications() {
    const button = document.getElementById('subscribe-button') as HTMLButtonElement;
    const status = document.getElementById('subscribe-status') as HTMLElement;
    
    if (!button || !status) return;
    
    // é€šçŸ¥ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (!('Notification' in window) || !('serviceWorker' in navigator)) {
      button.textContent = 'é€šçŸ¥ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
      button.disabled = true;
      return;
    }
    
    // ç¾åœ¨ã®é€šçŸ¥è¨±å¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    if (Notification.permission === 'granted') {
      button.style.display = 'none';
      status.style.display = 'flex';
    }
    
    // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    button.addEventListener('click', async () => {
      try {
        // é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
          // Service Workerã‚’ç™»éŒ²
          const registration = await navigator.serviceWorker.register('/sw.js');
          
          // Pushé€šçŸ¥ã‚’è³¼èª­
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(
              'YOUR_VAPID_PUBLIC_KEY' // å®Ÿéš›ã®VAPIDã‚­ãƒ¼ã«ç½®ãæ›ãˆã‚‹
            )
          });
          
          // ã‚µãƒ¼ãƒãƒ¼ã«è³¼èª­æƒ…å ±ã‚’é€ä¿¡
          await fetch('/api/subscribe', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(subscription)
          });
          
          // UIã‚’æ›´æ–°
          button.style.display = 'none';
          status.style.display = 'flex';
          
          // ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
          new Notification('ã‚»ãƒŸãƒ©ãƒŸã‚¹ã®åº­', {
            body: 'é€šçŸ¥ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼',
            icon: '/icon.jpg',
            badge: '/icon.jpg'
          });
        }
      } catch (error) {
        console.error('é€šçŸ¥ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('é€šçŸ¥ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    });
  }
  
  // Base64 URLã‚’Uint8Arrayã«å¤‰æ›
  function urlBase64ToUint8Array(base64String: string) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
      .replace(/\-/g, '+')
      .replace(/_/g, '/');
    
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }
  
  // åˆæœŸåŒ–
  document.addEventListener('astro:page-load', initNotifications);
  document.addEventListener('DOMContentLoaded', initNotifications);
</script>