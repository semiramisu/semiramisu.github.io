name: Translation Reminder

on:
  push:
    paths:
      - 'src/contents/posts/*.md'
      - '!src/contents/posts/en/**'
    branches:
      - main

jobs:
  check-translations:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check for untranslated posts
      id: check
      run: |
        # 翻訳が必要な記事を確認
        npm run translate:prepare > translation-check.txt 2>&1
        
        # 未翻訳記事の数を取得
        UNTRANSLATED=$(grep -o "📝 [0-9]*件の未翻訳記事" translation-check.txt | grep -o "[0-9]*" || echo "0")
        echo "untranslated_count=$UNTRANSLATED" >> $GITHUB_OUTPUT
        
        # 最近の未翻訳記事を取得（最大5件）
        echo "## 未翻訳記事" > translation-summary.md
        if [ "$UNTRANSLATED" -gt 0 ]; then
          sed -n '/^[0-9]\+\./,/^$/p' translation-check.txt | head -30 >> translation-summary.md
        fi
        
        cat translation-summary.md
    
    - name: Create issue if translations needed
      if: steps.check.outputs.untranslated_count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('translation-summary.md', 'utf8');
          const untranslatedCount = ${{ steps.check.outputs.untranslated_count }};
          
          // 既存のissueをチェック
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['translation-needed'],
            state: 'open'
          });
          
          if (issues.data.length === 0) {
            // 新しいissueを作成
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `🌐 ${untranslatedCount}件の記事の英訳が必要です`,
              body: `## 翻訳が必要な記事があります\n\n${summary}\n\n### 翻訳手順\n\n1. \`npm run translate:prepare\` を実行\n2. \`translation-prompts/\` ディレクトリのプロンプトをClaude Codeで翻訳\n3. 翻訳結果を \`translations/\` に保存\n4. \`npm run translate:apply\` で適用\n\n---\n*このissueは自動的に作成されました*`,
              labels: ['translation-needed']
            });
          }