name: Translation Reminder

on:
  push:
    paths:
      - 'src/contents/posts/*.md'
      - '!src/contents/posts/en/**'
    branches:
      - main

jobs:
  check-translations:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check for untranslated posts
      id: check
      run: |
        # ç¿»è¨³ãŒå¿…è¦ãªè¨˜äº‹ã‚’ç¢ºèª
        npm run translate:prepare > translation-check.txt 2>&1
        
        # æœªç¿»è¨³è¨˜äº‹ã®æ•°ã‚’å–å¾—
        UNTRANSLATED=$(grep -o "ğŸ“ [0-9]*ä»¶ã®æœªç¿»è¨³è¨˜äº‹" translation-check.txt | grep -o "[0-9]*" || echo "0")
        echo "untranslated_count=$UNTRANSLATED" >> $GITHUB_OUTPUT
        
        # æœ€è¿‘ã®æœªç¿»è¨³è¨˜äº‹ã‚’å–å¾—ï¼ˆæœ€å¤§5ä»¶ï¼‰
        echo "## æœªç¿»è¨³è¨˜äº‹" > translation-summary.md
        if [ "$UNTRANSLATED" -gt 0 ]; then
          sed -n '/^[0-9]\+\./,/^$/p' translation-check.txt | head -30 >> translation-summary.md
        fi
        
        cat translation-summary.md
    
    - name: Create issue if translations needed
      if: steps.check.outputs.untranslated_count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('translation-summary.md', 'utf8');
          const untranslatedCount = ${{ steps.check.outputs.untranslated_count }};
          
          // æ—¢å­˜ã®issueã‚’ãƒã‚§ãƒƒã‚¯
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['translation-needed'],
            state: 'open'
          });
          
          if (issues.data.length === 0) {
            // æ–°ã—ã„issueã‚’ä½œæˆ
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸŒ ${untranslatedCount}ä»¶ã®è¨˜äº‹ã®è‹±è¨³ãŒå¿…è¦ã§ã™`,
              body: `## ç¿»è¨³ãŒå¿…è¦ãªè¨˜äº‹ãŒã‚ã‚Šã¾ã™\n\n${summary}\n\n### ç¿»è¨³æ‰‹é †\n\n1. \`npm run translate:prepare\` ã‚’å®Ÿè¡Œ\n2. \`translation-prompts/\` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’Claude Codeã§ç¿»è¨³\n3. ç¿»è¨³çµæœã‚’ \`translations/\` ã«ä¿å­˜\n4. \`npm run translate:apply\` ã§é©ç”¨\n\n---\n*ã“ã®issueã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸ*`,
              labels: ['translation-needed']
            });
          }